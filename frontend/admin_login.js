// Variables globales
let currentUID = null
let socket = null
let tipoLogin = "tarjeta" // "tarjeta" o "username"
const io = window.io // Declare the io variable

// Elementos del DOM
const uidDisplay = document.getElementById("uid-display")
const usernameInput = document.getElementById("username-input")
const contrase√±aInput = document.getElementById("contrase√±a")
const submitBtn = document.getElementById("submit-btn")
const mensajeElement = document.getElementById("mensaje")

// Secciones
const seccionTarjeta = document.getElementById("seccion-tarjeta")
const seccionUsername = document.getElementById("seccion-username")

// Funci√≥n para mostrar mensajes
function mostrarMensaje(mensaje, tipo = "error") {
  if (mensajeElement) {
    mensajeElement.textContent = mensaje
    mensajeElement.className = `font-medium mb-4 p-3 rounded ${
      tipo === "error"
        ? "text-red-700 bg-red-50 border border-red-200"
        : tipo === "success"
          ? "text-green-700 bg-green-50 border border-green-200"
          : tipo === "warning"
            ? "text-yellow-700 bg-yellow-50 border border-yellow-200"
            : "text-blue-700 bg-blue-50 border border-blue-200"
    }`
  }
}

// Funci√≥n para cambiar tipo de login
function cambiarTipoLogin(nuevoTipo) {
  tipoLogin = nuevoTipo
  console.log(`üîÑ Cambiando tipo de login a: ${tipoLogin}`)

  if (tipoLogin === "tarjeta") {
    // Mostrar secci√≥n de tarjeta
    seccionTarjeta.classList.remove("hidden")
    seccionUsername.classList.add("hidden")

    // Conectar socket si no est√° conectado
    if (!socket) {
      conectarSocket()
    }
  } else {
    // Mostrar secci√≥n de username
    seccionTarjeta.classList.add("hidden")
    seccionUsername.classList.remove("hidden")

    // Desconectar socket si est√° conectado
    if (socket) {
      socket.disconnect()
      socket = null
    }

    // Enfocar campo de username
    usernameInput.focus()
  }

  // Limpiar estado
  currentUID = null
  mostrarMensaje("", "info")
  actualizarBotonEnvio()
}

// Event listeners para radio buttons
document.querySelectorAll('input[name="tipo-login"]').forEach((radio) => {
  radio.addEventListener("change", (e) => {
    cambiarTipoLogin(e.target.value)
  })
})

// Funci√≥n para actualizar UID autom√°ticamente (solo para tarjeta)
function actualizarUID(nuevoUID) {
  if (tipoLogin !== "tarjeta") return

  if (nuevoUID && nuevoUID !== currentUID) {
    console.log(`üîÑ Actualizando UID admin login: ${currentUID} ‚Üí ${nuevoUID}`)
    currentUID = nuevoUID

    if (uidDisplay) {
      uidDisplay.textContent = nuevoUID
      uidDisplay.className =
        "font-mono text-lg font-bold text-red-600 bg-red-50 px-3 py-1 rounded border-2 border-red-200 animate-pulse"

      // Quitar animaci√≥n despu√©s de 2 segundos
      setTimeout(() => {
        uidDisplay.className =
          "font-mono text-lg font-bold text-red-600 bg-red-50 px-3 py-1 rounded border-2 border-red-200"
      }, 2000)
    }

    mostrarMensaje("Tarjeta detectada para login de administrador.", "info")
    verificarAdminUID(nuevoUID)
  }
}

// Verificar si el UID pertenece a un administrador
async function verificarAdminUID(uid) {
  try {
    const response = await fetch("http://localhost:8000/usuarios/verificar_uid_admin/", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        Accept: "application/json",
      },
      body: JSON.stringify({ uid: uid }),
    })

    const data = await response.json()
    console.log("üìã Verificaci√≥n UID admin login:", data)

    if (data.existe) {
      mostrarMensaje(`Administrador encontrado: ${data.admin.nombre}`, "success")
      actualizarBotonEnvio()
    } else if (data.error) {
      mostrarMensaje(data.error, "error")
    } else {
      // Verificar si es otro tipo de usuario
      await verificarOtroTipoUsuario(uid)
    }
  } catch (error) {
    console.error("‚ùå Error verificando UID admin:", error)
    mostrarMensaje("Error verificando UID", "error")
  }
}

// Verificar si el UID pertenece a otro tipo de usuario
async function verificarOtroTipoUsuario(uid) {
  try {
    const response = await fetch("http://localhost:8000/usuarios/verificar_uid/", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        Accept: "application/json",
      },
      body: JSON.stringify({ uid: uid }),
    })

    const data = await response.json()
    console.log("üìã Verificaci√≥n otro usuario:", data)

    if (data.existe && data.usuario) {
      const rol = data.usuario.rol
      const nombre = data.usuario.nombre

      mostrarMensaje(`Esta tarjeta pertenece a ${nombre} (${rol}). Redirigiendo...`, "warning")

      setTimeout(() => {
        if (rol === "alumno") {
          window.location.href = "alumno_panel.html"
        } else if (rol === "docente") {
          window.location.href = "docente_panel.html"
        } else {
          window.location.href = "login.html"
        }
      }, 2000)
    } else {
      mostrarMensaje("Esta tarjeta no est√° registrada en el sistema.", "error")
    }
  } catch (error) {
    console.error("‚ùå Error verificando otro usuario:", error)
    mostrarMensaje("Esta tarjeta no pertenece a un administrador.", "error")
  }
}

// Conectar a Socket.IO para recibir UIDs en tiempo real (solo para tarjeta)
function conectarSocket() {
  if (tipoLogin !== "tarjeta") return

  try {
    socket = io("http://localhost:8000", {
      transports: ["polling", "websocket"],
      timeout: 10000,
    })

    socket.on("connect", () => {
      console.log("‚úÖ Socket conectado en admin login")
    })

    socket.on("respuesta_uid", (data) => {
      const nuevoUID = data.uid || data
      if (nuevoUID) {
        console.log("üì• Nuevo UID recibido en admin login:", nuevoUID)
        actualizarUID(nuevoUID)
      }
    })

    socket.on("disconnect", () => {
      console.log("üîå Socket desconectado en admin login")
    })
  } catch (error) {
    console.error("‚ùå Error conectando socket:", error)
  }
}

// Funci√≥n para actualizar estado del bot√≥n de env√≠o
function actualizarBotonEnvio() {
  let tieneIdentificador = false

  if (tipoLogin === "tarjeta") {
    tieneIdentificador = currentUID !== null
  } else {
    tieneIdentificador = usernameInput.value.trim().length >= 3
  }

  const tieneContrase√±a = contrase√±aInput.value.length > 0

  const puedeEnviar = tieneIdentificador && tieneContrase√±a

  submitBtn.disabled = !puedeEnviar

  if (puedeEnviar) {
    submitBtn.className =
      "w-full bg-red-600 hover:bg-red-700 text-white px-4 py-3 rounded font-medium transition-colors cursor-pointer"
  } else {
    submitBtn.className = "w-full bg-gray-400 text-gray-700 px-4 py-3 rounded font-medium cursor-not-allowed"
  }
}

// Event listeners para validaci√≥n en tiempo real
usernameInput.addEventListener("input", actualizarBotonEnvio)
contrase√±aInput.addEventListener("input", actualizarBotonEnvio)

// Manejar env√≠o del formulario - CORREGIDO
document.getElementById("admin-login-form").addEventListener("submit", async (e) => {
  e.preventDefault()

  let identificador = ""

  if (tipoLogin === "tarjeta") {
    identificador = currentUID
  } else {
    identificador = usernameInput.value.trim()
  }

  const contrase√±a = contrase√±aInput.value

  // Validaciones finales
  if (!identificador) {
    mostrarMensaje(
      tipoLogin === "tarjeta" ? "Debe acercar una tarjeta RFID." : "Debe ingresar un nombre de usuario.",
      "error",
    )
    return
  }

  if (!contrase√±a) {
    mostrarMensaje("Debe ingresar su contrase√±a.", "error")
    return
  }

  // Deshabilitar bot√≥n durante el env√≠o
  submitBtn.disabled = true
  submitBtn.textContent = "Iniciando sesi√≥n..."
  submitBtn.className = "w-full bg-gray-400 text-gray-700 px-4 py-3 rounded font-medium cursor-not-allowed"

  try {
    const payload = {
      uid: identificador,
      password: contrase√±a, // CORREGIDO: usar 'password' en lugar de 'contrase√±a'
    }

    console.log("üöÄ Enviando login de administrador:", payload)

    const response = await fetch("http://localhost:8000/usuarios/login", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        Accept: "application/json",
      },
      body: JSON.stringify(payload),
    })

    console.log(`üì° Respuesta del servidor: ${response.status}`)

    if (!response.ok) {
      const errorData = await response.json()
      console.error("‚ùå Error del servidor:", errorData)
      mostrarMensaje(`Error: ${errorData.detail || "Error en el login"}`, "error")
      return
    }

    const data = await response.json()
    console.log("üì• Respuesta exitosa:", data)

    if (data.rol === "admin") {
      mostrarMensaje("‚úÖ Login exitoso. Redirigiendo al panel de administraci√≥n...", "success")

      // Guardar datos del administrador
      localStorage.clear()
      localStorage.setItem("uid", data.uid)
      localStorage.setItem("userData", JSON.stringify(data))
      localStorage.setItem("usuario_rol", data.rol)
      localStorage.setItem("usuario_nombre", data.nombre)

      console.log("üíæ Datos de admin guardados en localStorage")

      setTimeout(() => {
        window.location.href = "admin_panel.html"
      }, 1500)
    } else {
      // Usuario no es admin, redirigir seg√∫n su rol
      mostrarMensaje(`Usted es ${data.rol}. Redirigiendo a su panel...`, "warning")

      localStorage.setItem("uid", data.uid)
      localStorage.setItem("userData", JSON.stringify(data))
      localStorage.setItem("usuario_rol", data.rol)
      localStorage.setItem("usuario_nombre", data.nombre)

      setTimeout(() => {
        if (data.rol === "alumno") {
          window.location.href = "alumno_panel.html"
        } else if (data.rol === "docente") {
          window.location.href = "docente_panel.html"
        } else {
          window.location.href = "index.html"
        }
      }, 2000)
    }
  } catch (error) {
    console.error("‚ùå Error en login admin:", error)
    mostrarMensaje("Error de conexi√≥n. Verifique que el servidor est√© funcionando.", "error")
  } finally {
    if (!document.getElementById("mensaje").textContent.includes("exitoso")) {
      submitBtn.disabled = false
      submitBtn.textContent = "Iniciar Sesi√≥n"
      actualizarBotonEnvio()
    }
  }
})

// Inicializar
document.addEventListener("DOMContentLoaded", () => {
  // Limpiar localStorage al cargar la p√°gina de login
  localStorage.clear()

  // Inicializar con tarjeta por defecto
  cambiarTipoLogin("tarjeta")

  // Enfocar campo de contrase√±a
  contrase√±aInput.focus()

  console.log("üîê Login de administrador inicializado")
})

// Limpiar socket al salir
window.addEventListener("beforeunload", () => {
  if (socket) {
    socket.disconnect()
  }
})
